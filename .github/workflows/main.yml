name: Notify Parent Repositories

on:
  push:
    branches:
      - master  # Change to the default branch of the `test` repository

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout submodule repository
        uses: actions/checkout@v3

      - name: Find repositories
        id: find_repos
        run: |
          # Get all repositories for the authenticated user
          repos=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                       -H "Accept: application/vnd.github.v3+json" \
                       "https://api.github.com/users/sosh-odoo/repos" \
                       | jq -r '.[] | .full_name')
          
          # Output the repositories to a file to use in subsequent steps
          echo "$repos" > repos.txt
          
      - name: Access repositories and trigger dispatch
        run: |
          # Read the repositories from the file
          repos=$(cat repos.txt)
          echo "Repositories: $repos"
          
          # Loop through each repository and trigger a dispatch event
          for repo in $repos; do
            echo "Processing repository: $repo"

            # Fetch the content of the .gitmodules file
            url_data=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                           "https://raw.githubusercontent.com/$repo/master/.gitmodules")

            # Check if the .gitmodules file contains the submodule "test"
            if echo "$url_data" | grep -F 'submodule "test"'; then
                echo "Submodule 'test' present in .gitmodules of $repo"

                # Trigger repository_dispatch event
                result=$(curl -L -X POST \
                            -H "Accept: application/vnd.github+json" \
                            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                            -H "X-GitHub-Api-Version: 2022-11-28" \
                            -d '{"event_type":"submodule-update"}' \
                            "https://api.github.com/repos/$repo/dispatches")
                
                # Optional: Check if the result contains any errors
                if echo "$result" | grep -q '"message":'; then
                    echo "Error triggering dispatch for $repo: $result"
                else
                    echo "Dispatch triggered successfully for $repo."
                fi
            else
                echo "Submodule 'test' not found in $repo .gitmodules."
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
