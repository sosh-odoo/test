name: Notify Parent Repositories

on:
  push:
    branches:
      - master  # Change to the default branch of the `test` repository

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout submodule repository
        uses: actions/checkout@v3

      - name: Find repositories
        id: find_repos
        run: |
          # Get all repositories for the authenticated user
          repos=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                       -H "Accept: application/vnd.github.v3+json" \
                       "https://api.github.com/users/sosh-odoo/repos" \
                       | jq -r '.[] | .full_name')
          
          # Output the repositories to a file to use in subsequent steps
          echo "$repos" > repos.txt
          
      - name: Access repositories and trigger dispatch
        run: |
          # Read the repositories from the file
          repos=$(cat repos.txt)
          echo "Repositories: $repos"
          
          # Loop through each repository and trigger a dispatch event
          for repo in $repos; do
            echo "Processing repository: $repo"

            # Fetch the content of the .gitmodules file
            url_data=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                           "https://raw.githubusercontent.com/$repo/master/.gitmodules")

            # Check if the .gitmodules file contains the submodule "test"
            if echo "$url_data" | grep -F 'submodule "test"'; then
                echo "Submodule 'test' present in .gitmodules of $repo"

                # Prepare the URL for the dispatch event
                workflow_url="https://api.github.com/repos/$repo/actions/workflows"
                echo "Triggering dispatch for $repo at $workflow_url"
                
                # Trigger repository_dispatch event
                result=$(curl -L \
                              -H "Accept: application/vnd.github+json" \
                              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                              -H "X-GitHub-Api-Version: 2022-11-28" \
                              $workflow_url)
                              
                # Extract workflow ID using jq
                workflow_id=$(echo "$result" | jq -r '.workflows[0].id')
                echo "$workflow_id"

                dispatch_url="https://api.github.com/repos/$repo/actions/workflows/$workflow_id/dispatches"
                echo "Trigger dispatch for: $dispatch_url"
                output_data=$(curl -L -X POST \
                        -H "Accept: application/vnd.github+json" \
                        -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                        -H "X-GitHub-Api-Version: 2022-11-28" \
                        $dispatch_url \
                        -d '{"ref":"master"}')
                echo "$output_data"
            else
                echo "Submodule 'test' not found in $repo .gitmodules."
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
