name: Notify Parent Repositories

on:
  push:
    branches:
      - master  # Change to the default branch of the `test` repository

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout submodule repository
        uses: actions/checkout@v3

      - name: Find and notify repositories
        run: |
          # Get all repositories for the authenticated user
          repos=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3+json" \
                   "https://api.github.com/users/sosh-odoo/repos" \
                   | jq -r '.[] | .full_name')
          echo "$repos"
          # Loop through each repository and trigger a dispatch event
          for repo in $repos; do
            # Check if the repository contains the submodule
            # Check if the .gitmodules file contains the submodule "test"
            url_data=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                       "https://raw.githubusercontent.com/sosh-odoo/$repo/master/.gitmodules" | grep -F 'submodule "test"')
            if $url_data; then
                # Trigger repository_dispatch event
                result=$(curl -L \
                            -X POST \
                            -H "Accept: application/vnd.github+json" \
                            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                            -H "X-GitHub-Api-Version: 2022-11-28" \
                            https://api.github.com/repos/sosh-odoo/$repo/dispatches \
                            -d '{"event_type":"submodule-update"}')
            
                # Optional: Check if the result contains any errors
                if echo "$result" | grep -q '"message":'; then
                    echo "Error triggering dispatch: $result"
                else
                    echo "Dispatch triggered successfully."
                fi
            else
                echo "Submodule 'test' not found in $repo .gitmodules."
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
